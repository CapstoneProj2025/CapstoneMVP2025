<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="container d-flex align-items-center justify-content-between py-3">
    <a class="brand" href="index.html">
      <div class="logo">EDU</div>
      <div class="name">Edu Platform</div>
    </a>

    <div class="d-flex align-items-center gap-3">
      <button id="settingsButton" class="btn btn-outline-secondary btn-pill">ðŸ”¥ My Progress</button>
    </div>
  </header>

  <main class="dashboard-container">
    <div class="dashboard-top-bar">
      <div>
        <div class="dashboard-title">Welcome, <span id="studentName">Student</span></div>
        <div class="text-muted small">
          Parent: <span id="parentName">â€”</span>
          <span id="parentEmail"></span>
        </div>
      </div>

      <div class="subject-select">
        <label for="subjectSelect" class="text-muted">Subject</label>
        <select id="subjectSelect" class="form-select form-select-sm">
          <option value="Engineering">Engineering</option>
          <option value="Physics">Physics</option>
          <option value="Maths">Maths</option>
        </select>
      </div>
    </div>

    <div class="learning-root">
      <div id="learningSelection" class="learning-selection">
        <div class="selection-card">
          <div class="selection-top-bar">
            <div></div>
            <button id="settingsIcon" class="settings-icon" title="My Progress">ðŸ”¥</button>
          </div>

          <div class="selection-title">Choose what to do</div>
          <div class="selection-subtitle">Lessons, videos, or games tailored to your subject.</div>

          <div class="selection-buttons">
            <button class="selection-btn" data-format="lessons">Lessons</button>
            <button class="selection-btn" data-format="videos">Videos</button>
            <button class="selection-btn" data-format="games">Games</button>
          </div>
        </div>
      </div>

      <div id="learningPanel" class="learning-panel">
        <div class="lesson-format-dropdown" id="lessonFormatDropdown">
          <button class="dropdown-toggle" id="lessonFormatToggle">
            <span id="lessonFormatLabel">Lessons</span>
            <span class="caret">â–¼</span>
          </button>

          <ul class="dropdown-menu-custom" id="lessonFormatMenu">
            <li data-format="lessons">Lessons</li>
            <li data-format="videos">Videos</li>
            <li data-format="games">Games</li>
          </ul>
        </div>

        <div class="learning-placeholder">
          <div id="lessonsSimpleLayout" class="simple-media-layout">
            <div class="simple-media-main">
              <button id="recommendedLessonBtn" class="simple-media-card">
                <div class="simple-media-rect">
                  <div class="simple-media-kicker">Recommended lesson</div>
                  <div class="simple-media-title" id="lessonCardTitle">Lesson title</div>
                  <div class="simple-media-sub" id="lessonCardSub">Click to start</div>
                </div>
              </button>
            </div>

            <div class="simple-media-sidebar">
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="lessonMini1">Lesson idea 1</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="lessonMini2">Lesson idea 2</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="lessonMini3">Lesson idea 3</div></div>
            </div>
          </div>

          <div id="videosSimpleLayout" class="simple-media-layout">
            <div class="simple-media-main">
              <button id="recommendedVideoBtn" class="simple-media-card">
                <div class="simple-media-rect">
                  <div class="simple-media-kicker">Recommended video</div>
                  <div class="simple-media-title" id="videoCardTitle">Video title</div>
                  <div class="simple-media-sub" id="videoCardSub">Click to watch</div>
                </div>
              </button>
            </div>

            <div class="simple-media-sidebar">
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="videoMini1">Similar video 1</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="videoMini2">Similar video 2</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="videoMini3">Similar video 3</div></div>
            </div>
          </div>

          <div id="gamesSimpleLayout" class="simple-media-layout">
            <div class="simple-media-main">
              <button id="recommendedGameBtn" class="simple-media-card">
                <div class="simple-media-rect">
                  <div class="simple-media-kicker">Recommended game</div>
                  <div class="simple-media-title" id="gameCardTitle">Game title</div>
                  <div class="simple-media-sub" id="gameCardSub">Click to open</div>
                </div>
              </button>
            </div>

            <div class="simple-media-sidebar">
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="gameMini1">Game idea 1</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="gameMini2">Game idea 2</div></div>
              <div class="simple-media-mini"><div class="simple-media-mini-title" id="gameMini3">Game idea 3</div></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- LESSON VIEWER MODAL -->
    <div id="lessonViewerModal" class="viewer-modal">
      <div class="viewer-card">
        <div class="viewer-header">
          <div>
            <div class="viewer-title" id="lessonViewerTitle">Lesson title</div>
            <div class="viewer-subtitle" id="lessonViewerOverview">Overview goes here</div>
          </div>
        </div>

        <div class="viewer-body">
          <div class="viewer-grid">
            <div class="viewer-section">
              <div id="lessonBlocks"></div>
            </div>

            <div class="viewer-section">
              <div class="viewer-question-title" id="lessonQuestionText">Question</div>
              <div class="viewer-answers">
                <button class="answer-option" id="answer-1" data-correct="false">Answer 1</button>
                <button class="answer-option" id="answer-2" data-correct="false">Answer 2</button>
                <button class="answer-option" id="answer-3" data-correct="false">Answer 3</button>
                <button class="answer-option" id="answer-4" data-correct="false">Answer 4</button>
              </div>
            </div>
          </div>

          <div class="viewer-actions">
            <button id="exitLessonViewingBtn" class="btn btn-outline-secondary btn-pill">Exit viewing</button>
            <button id="lessonBackToDashboardBtn" class="btn btn-primary btn-pill">Back to dashboard</button>
          </div>
        </div>
      </div>
    </div>

    <!-- VIDEO VIEWER MODAL -->
    <div id="videoViewerModal" class="viewer-modal">
      <div class="viewer-card">
        <div class="viewer-header">
          <div>
            <div class="viewer-title" id="videoViewerTitle">Video title</div>
            <div class="viewer-subtitle" id="videoViewerSubtitle">Enjoy the lesson video.</div>
          </div>
        </div>

        <div class="viewer-body">
          <div class="ratio ratio-16x9">
            <iframe
              id="videoIframe"
              src=""
              title="Video"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>

          <div class="viewer-actions" style="margin-top: 14px;">
            <button id="exitVideoViewingBtn" class="btn btn-outline-secondary btn-pill">Exit viewing</button>
            <button id="videoBackToDashboardBtn" class="btn btn-primary btn-pill">Back to dashboard</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LESSON COMPLETE MODAL -->
    <div id="lessonCompleteModal" class="lesson-complete-modal">
      <div class="lesson-complete-card">
        <div class="lesson-complete-icon">ðŸŽ‰</div>
        <div class="lesson-complete-title">Great Job!</div>
        <div class="lesson-complete-subtitle">You completed this lesson.</div>
        <button id="backToDashboardBtn" class="btn btn-primary btn-pill">Back to dashboard</button>
      </div>
    </div>

    <!-- GAME VIEWER MODAL -->
    <div id="gameViewerModal" class="viewer-modal">
      <div class="viewer-card">
        <div class="viewer-header">
          <div>
            <div class="viewer-title" id="gameViewerTitle">Game title</div>
            <div class="viewer-subtitle" id="gameViewerOverview">Have fun!</div>
          </div>
        </div>

        <div class="viewer-body">
          <div class="ratio ratio-16x9">
            <iframe id="gameIframe" src="" title="Game" frameborder="0"></iframe>
          </div>

          <div class="viewer-actions" style="margin-top: 14px;">
            <button id="exitGameViewingBtn" class="btn btn-outline-secondary btn-pill">Exit game</button>
            <button id="gameBackToDashboardBtn" class="btn btn-primary btn-pill">Back to dashboard</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STREAK CARD - Fixed Bottom Left -->
    <div id="streakCard" style="
      position: fixed;
      bottom: 24px;
      left: 24px;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
      z-index: 1000;
      min-width: 160px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0, 0, 0, 0.15)';" 
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.1)';">
      <div style="font-size: 48px; margin-bottom: 8px; animation: flicker 2s ease-in-out infinite;">ðŸ”¥</div>
      <div style="font-size: 48px; font-weight: 700; color: #333; line-height: 1; margin-bottom: 4px;">
        <span id="streakNumber">0</span>
      </div>
      <div style="font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
        Day Streak
      </div>
    </div>

    <!-- SETTINGS MODAL (Hidden by default, shown when My Progress button is clicked) -->
    <div id="settingsModal" class="settings-modal" style="display: none;">
      <div class="settings-card" style="max-width: 400px;">
        <div class="settings-header">
          <div class="settings-title">Your Progress</div>
          <button id="closeSettingsBtn" class="settings-close-btn">Ã—</button>
        </div>

        <div class="settings-body" style="padding: 40px 20px; text-align: center;">
          <!-- Large Streak Card in Modal -->
          <div style="
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
            display: inline-block;
            min-width: 250px;
          ">
            <div style="font-size: 64px; margin-bottom: 16px; animation: flicker 2s ease-in-out infinite;">ðŸ”¥</div>
            <div style="font-size: 72px; font-weight: 700; color: #333; line-height: 1; margin-bottom: 8px;">
              <span id="settingsStreak">0</span>
            </div>
            <div style="font-size: 18px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 1px;">
              Day Streak
            </div>
            <div style="margin-top: 20px; font-size: 14px; color: #888;">
              Keep learning every day!
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    @keyframes flicker {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.85; }
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const studentNameEl = document.getElementById("studentName");
      const subjectSelect = document.getElementById("subjectSelect");

      const settingsButton = document.getElementById("settingsButton");
      const settingsIcon = document.getElementById("settingsIcon");
      const settingsModal = document.getElementById("settingsModal");
      const closeSettingsBtn = document.getElementById("closeSettingsBtn");

      const settingsStreak = document.getElementById("settingsStreak");
      const streakNumber = document.getElementById("streakNumber");

      const learningSelection = document.getElementById("learningSelection");
      const learningPanel = document.getElementById("learningPanel");

      const lessonsSimpleLayout = document.getElementById("lessonsSimpleLayout");
      const videosSimpleLayout = document.getElementById("videosSimpleLayout");
      const gamesSimpleLayout = document.getElementById("gamesSimpleLayout");

      const selectionButtons = document.querySelectorAll(".selection-btn");

      const dropdown = document.getElementById("lessonFormatDropdown");
      const toggleBtn = document.getElementById("lessonFormatToggle");
      const formatLabel = document.getElementById("lessonFormatLabel");
      const menu = document.getElementById("lessonFormatMenu");

      const recommendedLessonBtn = document.getElementById("recommendedLessonBtn");
      const recommendedVideoBtn = document.getElementById("recommendedVideoBtn");
      const recommendedGameBtn = document.getElementById("recommendedGameBtn");

      const lessonViewerModal = document.getElementById("lessonViewerModal");
      const exitLessonViewingBtn = document.getElementById("exitLessonViewingBtn");
      const lessonBackToDashboardBtn = document.getElementById("lessonBackToDashboardBtn");

      const videoViewerModal = document.getElementById("videoViewerModal");
      const videoIframe = document.getElementById("videoIframe");
      const exitVideoViewingBtn = document.getElementById("exitVideoViewingBtn");
      const videoBackToDashboardBtn = document.getElementById("videoBackToDashboardBtn");

      const lessonCompleteModal = document.getElementById("lessonCompleteModal");
      const backToDashboardBtn = document.getElementById("backToDashboardBtn");

      const gameViewerModal = document.getElementById("gameViewerModal");
      const gameIframe = document.getElementById("gameIframe");
      const exitGameViewingBtn = document.getElementById("exitGameViewingBtn");
      const gameBackToDashboardBtn = document.getElementById("gameBackToDashboardBtn");

      let currentFormat = "lessons";
      let currentSubject = "Engineering";

      // Check localStorage for studentId
      const studentId = localStorage.getItem("studentId");
      if (!studentId) {
        alert("No student ID found. Redirecting to login.");
        window.location.href = "index.html";
        return;
      }

      // Settings modal
      function openSettingsModal() {
        if (settingsModal) {
          settingsModal.style.display = "flex";
          settingsModal.classList.add("active");
        }
      }

      function closeSettingsModal() {
        if (settingsModal) {
          settingsModal.style.display = "none";
          settingsModal.classList.remove("active");
        }
      }

      if (settingsButton) settingsButton.addEventListener("click", openSettingsModal);
      if (settingsIcon) settingsIcon.addEventListener("click", openSettingsModal);
      if (closeSettingsBtn) closeSettingsBtn.addEventListener("click", closeSettingsModal);

      // Fetch student data using the new endpoint
      try {
        console.log("ðŸ“¡ Fetching student data for ID:", studentId);
        const res = await fetch(`http://localhost:3000/api/student-dashboard-data?studentId=${studentId}`);
        console.log("ðŸ“¡ Response status:", res.status);
        
        const data = await res.json();
        console.log("ðŸ“¦ Response data:", data);

        if (data.success && data.student) {
          const student = data.student;

          console.log("âœ… Student data:", student);

          const studentName = student.name || "Student";
          const streakDays = student.streakDays || 0;

          if (studentNameEl) studentNameEl.textContent = studentName;
          if (settingsStreak) settingsStreak.textContent = streakDays;
          if (streakNumber) streakNumber.textContent = streakDays;

        } else {
          console.error("âŒ API returned success=false or no student data:", data);
          alert("Could not load student data.");
          window.location.href = "index.html";
        }
      } catch (err) {
        console.error("âŒ Error loading student data:", err);
        alert("Error loading student data.");
      }

      async function incrementStreak(activity = "lesson") {
        try {
          const res = await fetch("http://localhost:3000/api/streak/increment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ studentId: Number(studentId), activity }),
          });
          const data = await res.json();
          if (data.success) {
            console.log("âœ… Streak incremented:", data);
            if (settingsStreak) settingsStreak.textContent = data.streakDays || 0;
            if (streakNumber) streakNumber.textContent = data.streakDays || 0;
          }
        } catch (err) {
          console.error("âŒ Error incrementing streak:", err);
        }
      }

      async function logActivity(activityType, contentTitle, durationMinutes = 5) {
        try {
          const subject = subjectSelect ? subjectSelect.value : "Engineering";
          const res = await fetch("http://localhost:3000/api/activity/log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              studentId: Number(studentId),
              activityType,
              subject,
              contentTitle,
              durationMinutes
            }),
          });
          const data = await res.json();
          if (data.success) {
            console.log("âœ… Activity logged:", activityType, contentTitle);
          }
        } catch (err) {
          console.error("âŒ Error logging activity:", err);
        }
      }

      async function fetchContent(subject, format, index = 0) {
        const res = await fetch(`http://localhost:3000/api/content?subject=${subject}&format=${format}&index=${index}`);
        const data = await res.json();
        return data.success ? data.item : null;
      }

      function renderLessonCard(item) {
        if (!item) return;
        const titleEl = document.getElementById("lessonCardTitle");
        const subEl = document.getElementById("lessonCardSub");
        if (titleEl) titleEl.textContent = item.title || "Lesson";
        if (subEl) subEl.textContent = item.overview || "Click to start";
      }

      function renderLessonMinis() {
        const mini1 = document.getElementById("lessonMini1");
        const mini2 = document.getElementById("lessonMini2");
        const mini3 = document.getElementById("lessonMini3");

        if (mini1) mini1.textContent = "Explore more lessons";
        if (mini2) mini2.textContent = "Try another topic";
        if (mini3) mini3.textContent = "Challenge yourself";
      }

      function renderVideoCard(item) {
        if (!item) return;
        const titleEl = document.getElementById("videoCardTitle");
        const subEl = document.getElementById("videoCardSub");
        if (titleEl) titleEl.textContent = item.title || "Video";
        if (subEl) subEl.textContent = item.youtubeId ? "Click to watch" : "No video available";
      }

      function renderGameCard(item) {
        if (!item) return;
        const titleEl = document.getElementById("gameCardTitle");
        const subEl = document.getElementById("gameCardSub");
        if (titleEl) titleEl.textContent = item.title || "Game";
        if (subEl) subEl.textContent = item.url ? "Click to open" : "No game available";
      }

      function renderGameMinis() {
        const mini1 = document.getElementById("gameMini1");
        const mini2 = document.getElementById("gameMini2");
        const mini3 = document.getElementById("gameMini3");

        if (mini1) mini1.textContent = "More games coming soon";
        if (mini2) mini2.textContent = "Try a different subject";
        if (mini3) mini3.textContent = "Explore challenges";
      }

      function renderLessonViewer(item) {
        if (!item) return;

        const titleEl = document.getElementById("lessonViewerTitle");
        const overviewEl = document.getElementById("lessonViewerOverview");
        const blocksEl = document.getElementById("lessonBlocks");
        const questionEl = document.getElementById("lessonQuestionText");

        if (titleEl) titleEl.textContent = item.title || "Lesson";
        if (overviewEl) overviewEl.textContent = item.overview || "";

        if (blocksEl && Array.isArray(item.blocks)) {
          blocksEl.innerHTML = "";
          item.blocks.forEach(block => {
            const div = document.createElement("div");
            div.className = "viewer-block";

            const h = document.createElement("h3");
            h.className = "viewer-block-title";
            h.textContent = block.heading || "";
            div.appendChild(h);

            const p = document.createElement("p");
            p.textContent = block.content || "";
            div.appendChild(p);

            blocksEl.appendChild(div);
          });
        }

        const quiz = item.quiz || {};
        if (questionEl) questionEl.textContent = quiz.question || "Question";

        const answers = quiz.answers || [];
        const correctIndex = quiz.correctIndex ?? -1;

        const answerButtons = [
          document.getElementById("answer-1"),
          document.getElementById("answer-2"),
          document.getElementById("answer-3"),
          document.getElementById("answer-4"),
        ].filter(Boolean);

        answerButtons.forEach((btn, i) => {
          if (answers[i]) {
            btn.textContent = answers[i];
            btn.dataset.correct = (i === correctIndex) ? "true" : "false";
          } else {
            btn.textContent = "â€”";
            btn.dataset.correct = "false";
          }
        });
      }

      function renderGameViewer(item) {
        if (!item) return;
        const titleEl = document.getElementById("gameViewerTitle");
        if (titleEl) titleEl.textContent = item.title || "Game";

        if (gameIframe && item.url) {
          gameIframe.src = item.url;
          gameIframe.title = item.title || "Game";
        }
      }

      async function loadCurrentContent() {
        currentSubject = subjectSelect ? subjectSelect.value : "Engineering";

        try {
          if (currentFormat === "lessons") {
            const item = await fetchContent(currentSubject, "lessons", 0);
            renderLessonCard(item);
            renderLessonMinis();
            if (recommendedLessonBtn) recommendedLessonBtn.dataset.lesson = JSON.stringify(item);
          }

          if (currentFormat === "videos") {
            const item = await fetchContent(currentSubject, "videos", 0);
            renderVideoCard(item);
            if (recommendedVideoBtn) recommendedVideoBtn.dataset.video = JSON.stringify(item);
          }

          if (currentFormat === "games") {
            const item = await fetchContent(currentSubject, "games", 0);
            renderGameCard(item);
            renderGameMinis();
            if (recommendedGameBtn) recommendedGameBtn.dataset.game = JSON.stringify(item);
          }
        } catch (err) {
          console.error("âŒ Content load error:", err);
        }
      }

      function setActiveFormat(format) {
        currentFormat = format;

        if (lessonsSimpleLayout) lessonsSimpleLayout.style.display = (format === "lessons") ? "flex" : "none";
        if (videosSimpleLayout) videosSimpleLayout.style.display = (format === "videos") ? "flex" : "none";
        if (gamesSimpleLayout) gamesSimpleLayout.style.display = (format === "games") ? "flex" : "none";

        if (formatLabel) formatLabel.textContent = format.charAt(0).toUpperCase() + format.slice(1);

        loadCurrentContent();
      }

      function showPanelFor(format) {
        if (learningSelection) learningSelection.style.display = "none";
        if (learningPanel) learningPanel.style.display = "block";
        setActiveFormat(format);
      }

      selectionButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const format = btn.getAttribute("data-format") || "lessons";
          showPanelFor(format);
        });
      });

      if (toggleBtn && dropdown && menu) {
        toggleBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          dropdown.classList.toggle("open");
        });

        document.addEventListener("click", () => dropdown.classList.remove("open"));

        menu.querySelectorAll("li").forEach(li => {
          li.addEventListener("click", () => {
            const format = li.getAttribute("data-format");
            dropdown.classList.remove("open");
            if (format) setActiveFormat(format);
          });
        });
      }

      if (subjectSelect) {
        subjectSelect.addEventListener("change", () => loadCurrentContent());
      }

      // Video modal open/close
      function openVideoModal() {
        if (!videoViewerModal || !recommendedVideoBtn) return;
        const raw = recommendedVideoBtn.dataset.video;
        if (!raw) return;

        const item = JSON.parse(raw);
        const titleEl = document.getElementById("videoViewerTitle");
        if (titleEl) titleEl.textContent = item.title || "Video";

        if (videoIframe && item.youtubeId) {
          videoIframe.src = `https://www.youtube.com/embed/${item.youtubeId}`;
          videoIframe.title = item.title || "Video";
        }

        videoViewerModal.classList.add("active");
      }

      function closeVideoModal(stopPlayback = true) {
        if (stopPlayback && videoIframe) videoIframe.src = "";
        if (videoViewerModal) videoViewerModal.classList.remove("active");
      }

      if (recommendedVideoBtn) recommendedVideoBtn.addEventListener("click", openVideoModal);
      if (exitVideoViewingBtn) exitVideoViewingBtn.addEventListener("click", () => closeVideoModal(true));

      if (videoBackToDashboardBtn) {
        videoBackToDashboardBtn.addEventListener("click", async () => {
          // Get video info
          const raw = recommendedVideoBtn ? recommendedVideoBtn.dataset.video : null;
          const videoTitle = raw ? JSON.parse(raw).title : "Video";
          
          await logActivity("video", videoTitle, 10);
          await incrementStreak("video");
          closeVideoModal(true);

          if (learningPanel) learningPanel.style.display = "none";
          if (learningSelection) learningSelection.style.display = "flex";
          setActiveFormat("lessons");
        });
      }

      // Lesson modal open/close + quiz
      function openLessonModal() {
        if (!lessonViewerModal || !recommendedLessonBtn) return;
        const raw = recommendedLessonBtn.dataset.lesson;
        if (!raw) return;
        const item = JSON.parse(raw);
        renderLessonViewer(item);
        lessonViewerModal.classList.add("active");
      }

      function closeLessonModal() {
        if (lessonViewerModal) lessonViewerModal.classList.remove("active");
      }

      if (recommendedLessonBtn) recommendedLessonBtn.addEventListener("click", openLessonModal);
      if (exitLessonViewingBtn) exitLessonViewingBtn.addEventListener("click", closeLessonModal);

      if (lessonBackToDashboardBtn) {
        lessonBackToDashboardBtn.addEventListener("click", async () => {
          // Get lesson info
          const raw = recommendedLessonBtn ? recommendedLessonBtn.dataset.lesson : null;
          const lessonTitle = raw ? JSON.parse(raw).title : "Lesson";
          
          await logActivity("lesson", lessonTitle, 15);
          await incrementStreak("lesson");
          closeLessonModal();

          if (learningPanel) learningPanel.style.display = "none";
          if (learningSelection) learningSelection.style.display = "flex";
          setActiveFormat("lessons");
        });
      }

      const answerButtons = [
        document.getElementById("answer-1"),
        document.getElementById("answer-2"),
        document.getElementById("answer-3"),
        document.getElementById("answer-4"),
      ].filter(Boolean);

      answerButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const isCorrect = btn.dataset.correct === "true";
          const flashClass = isCorrect ? "flash-correct" : "flash-incorrect";

          btn.classList.remove("flash-correct", "flash-incorrect");
          void btn.offsetWidth;
          btn.classList.add(flashClass);

          setTimeout(() => btn.classList.remove(flashClass), 350);

          if (isCorrect && lessonCompleteModal) lessonCompleteModal.classList.add("active");
        });
      });

      if (backToDashboardBtn && lessonCompleteModal) {
        backToDashboardBtn.addEventListener("click", async () => {
          // Get lesson info
          const raw = recommendedLessonBtn ? recommendedLessonBtn.dataset.lesson : null;
          const lessonTitle = raw ? JSON.parse(raw).title : "Lesson";
          
          await logActivity("lesson", lessonTitle, 15);
          await incrementStreak("lesson");

          lessonCompleteModal.classList.remove("active");
          closeLessonModal();

          if (learningPanel) learningPanel.style.display = "none";
          if (learningSelection) learningSelection.style.display = "flex";
          setActiveFormat("lessons");
        });
      }

      // Game modal open/close
      function openGameModal() {
        if (!gameViewerModal || !recommendedGameBtn) return;
        const raw = recommendedGameBtn.dataset.game;
        if (!raw) return;
        const item = JSON.parse(raw);
        renderGameViewer(item);
        gameViewerModal.classList.add("active");
      }

      function closeGameModal() {
        if (gameIframe) gameIframe.src = "";
        if (gameViewerModal) gameViewerModal.classList.remove("active");
      }

      if (recommendedGameBtn) recommendedGameBtn.addEventListener("click", openGameModal);
      if (exitGameViewingBtn) exitGameViewingBtn.addEventListener("click", closeGameModal);

      if (gameBackToDashboardBtn) {
        gameBackToDashboardBtn.addEventListener("click", async () => {
          // Get game info
          const raw = recommendedGameBtn ? recommendedGameBtn.dataset.game : null;
          const gameTitle = raw ? JSON.parse(raw).title : "Game";
          
          await logActivity("game", gameTitle, 20);
          await incrementStreak("game");
          closeGameModal();

          if (learningPanel) learningPanel.style.display = "none";
          if (learningSelection) learningSelection.style.display = "flex";
          setActiveFormat("lessons");
        });
      }

      // âœ… FIX: Load initial content when page loads
      // This ensures the data attributes are set before users click
      await loadCurrentContent();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>