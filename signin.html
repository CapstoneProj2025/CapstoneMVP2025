<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sign In</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="container d-flex align-items-center justify-content-between my-3">
    <a class="brand d-flex align-items-center text-decoration-none" href="index.html" aria-label="Back to home">
        <div class="logo d-flex align-items-center justify-content-center">CN</div>
        <div class="name">Sign In</div>
    </a>
</header>

<main class="signup-page container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 signup-card">
                <div class="card-body p-4 p-md-5">
                    <h1 class="h4 mb-2 text-center">Sign in to your account</h1>
                    <p class="text-muted text-center mb-4">
                        Enter your email and password to continue.
                    </p>

                    <div id="loginMessage" class="alert d-none" role="alert"></div>

                    <form id="loginForm" novalidate>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <div class="mb-4">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="loginButton">
                            Sign In
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
function showLoginMessage(text, type) {
    const box = document.getElementById('loginMessage');
    box.textContent = text;
    box.className = 'alert alert-' + type;
    box.classList.remove('d-none');
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showLoginMessage('Please enter a valid email and password.', 'danger');
            return;
        }

        const data = {
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        };

        loginButton.disabled = true;
        loginButton.textContent = 'Signing in...';
        showLoginMessage('', ''); // clear

        try {
            const response = await fetch('http://localhost:3000/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                showLoginMessage(result.message || 'Login failed.', 'danger');
            } else {
                if (result.role === 'student') {
                    const url =
                        `studentdashboard.html?studentId=${encodeURIComponent(result.studentId)}` +
                        `&name=${encodeURIComponent(result.name)}` +
                        `&interests=${encodeURIComponent(result.interest || '')}` +
                        `&parentName=${encodeURIComponent(result.parentName || '')}` +
                        `&parentEmail=${encodeURIComponent(result.parentEmail || '')}`;
                    window.location.href = url;
                } else if (result.role === 'parent') {
                    const url =
                        `parentdashboard.html?id=${encodeURIComponent(result.parentId)}` +
                        `&role=parent&name=${encodeURIComponent(result.name)}`;
                    window.location.href = url;
                } else {
                    showLoginMessage('Unknown account type.', 'danger');
                }
            }
        } catch (err) {
            console.error(err);
            showLoginMessage('Network error. Is the server running on port 3000?', 'danger');
        } finally {
            loginButton.disabled = false;
            loginButton.textContent = 'Sign In';
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>