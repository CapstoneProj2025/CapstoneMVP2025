<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>User Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="container d-flex align-items-center justify-content-between my-3">
    <div class="brand d-flex align-items-center">
        <div class="logo">CN</div>
        <div class="name">User Settings</div>
    </div>
    <a class="btn btn-primary" href="index.html">Home</a>
</header>

<main class="settings-page container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body p-4 p-md-5">
                    <h1 class="h4 mb-2 text-center">Profile details</h1>
                    <p class="text-muted text-center mb-4">
                        Update your information and save changes.
                    </p>

                    <div id="settingsMessage" class="alert d-none" role="alert"></div>

                    <form id="settingsForm" class="needs-validation" novalidate>
                        <input type="hidden" id="studentId" name="studentId">

                        <div class="mb-3">
                            <label class="form-label" for="studentName">Full Name</label>
                            <input type="text" class="form-control" id="studentName" name="studentName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="studentEmail">Email</label>
                            <input type="email" class="form-control" id="studentEmail" name="studentEmail" required>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="studentAge">Age</label>
                                <input type="number" class="form-control" id="studentAge" name="studentAge" required min="5" max="18">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="studentInterests">Key interest</label>
                                <select class="form-select" id="studentInterests" name="studentInterests" required>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Maths">Maths</option>
                                </select>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" for="parentName">Parent / Guardian Name</label>
                                <input type="text" class="form-control" id="parentName" name="parentName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" for="parentEmail">Parent / Guardian Email</label>
                                <input type="email" class="form-control" id="parentEmail" name="parentEmail" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-4">
                            Submit New Info
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('settingsForm');
    const messageBox = document.getElementById('settingsMessage');

    // Pre-fill from query string (basic version)
    document.getElementById('studentId').value       = getQueryParam('studentId') || '';
    document.getElementById('studentName').value     = getQueryParam('name') || '';
    document.getElementById('studentInterests').value = getQueryParam('interests') || 'Engineering';
    document.getElementById('parentName').value      = getQueryParam('parentName') || '';
    document.getElementById('parentEmail').value     = getQueryParam('parentEmail') || '';

    function showMessage(text, type) {
        messageBox.className = 'alert alert-' + type;
        messageBox.textContent = text;
        messageBox.classList.remove('d-none');
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showMessage('Please fill in all required fields.', 'danger');
            return;
        }

        const data = {
            studentId:        document.getElementById('studentId').value,
            studentName:      document.getElementById('studentName').value,
            studentEmail:     document.getElementById('studentEmail').value,
            studentAge:       document.getElementById('studentAge').value,
            studentInterests: document.getElementById('studentInterests').value,
            parentName:       document.getElementById('parentName').value,
            parentEmail:      document.getElementById('parentEmail').value,
        };

        try {
            const response = await fetch('http://localhost:3000/api/update-student-profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();
            if (response.ok && result.success) {
                showMessage('Profile updated successfully.', 'success');
            } else {
                showMessage(result.message || 'Failed to update profile.', 'danger');
            }
        } catch (err) {
            console.error(err);
            showMessage('Network error talking to the server.', 'danger');
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
