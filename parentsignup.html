<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Parent Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header class="container d-flex align-items-center justify-content-between my-3">
    <a class="brand d-flex align-items-center text-decoration-none" href="index.html" aria-label="Back to home">
        <div class="logo d-flex align-items-center justify-content-center">CN</div>
        <div class="name">Parent Sign Up</div>
    </a>
</header>

<main class="signup-page container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0 signup-card">
                <div class="card-body p-4 p-md-5">
                    <h1 class="h4 mb-2 text-center">Parent/Administrator Account Creation</h1>
                    <p class="text-muted text-center mb-4">
                        Create your account and register your first student simultaneously.
                    </p>

                    <div id="signupMessage" class="alert d-none" role="alert"></div>

                    <form id="parentSignupForm" novalidate>
                        <!-- Parent Information Section -->
                        <h4 class="mb-3">Your Account Details</h4>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="parentName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="parentName" name="parentName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="parentEmail" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="parentEmail" name="parentEmail" required>
                            </div>
                            <div class="col-12">
                                <label for="parentPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="parentPassword" name="parentPassword" required minlength="8">
                                <div class="form-text">Must be at least 8 characters long.</div>
                            </div>
                        </div>

                        <!-- Student Information Section -->
                        <h4 class="mb-3">Child's Student Account Details</h4>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="studentName" class="form-label">Student's Full Name</label>
                                <input type="text" class="form-control" id="studentName" name="studentName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="studentEmail" class="form-label">Student's Email (or preferred Username)</label>
                                <input type="email" class="form-control" id="studentEmail" name="studentEmail" required>
                            </div>
                            <div class="col-md-6">
                                <label for="studentAge" class="form-label">Student's Age</label>
                                <input type="number" class="form-control" id="studentAge" name="studentAge" required min="5" max="18">
                            </div>
                            <div class="col-md-6">
                                <label for="studentInterests" class="form-label">Student's Key Interest</label>
                                <select class="form-select" id="studentInterests" name="studentInterests" required>
                                    <option value="">Choose one...</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Maths">Maths</option>
                                </select>
                                <div class="form-text">What core subject area excites them the most?</div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="parentSubmitButton">
                            Create Parent & Student Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- EmailJS CDN and Init -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
    (function() {
        emailjs.init({
            publicKey: "-HLsmBoRt7JAgdZ3E",
        });
    })();
</script>

<script>
function displayMessage(text, type) {
    const box = document.getElementById('signupMessage');
    box.textContent = text;
    box.className = 'alert alert-' + type;
    box.classList.remove('d-none');
}

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('parentSignupForm');
    const submitButton = document.getElementById('parentSubmitButton');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            displayMessage('Please fill in all required fields correctly.', 'danger');
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        submitButton.disabled = true;
        submitButton.textContent = 'Creating Account...';
        displayMessage('', ''); // clear previous message

        try {
            const response = await fetch('http://localhost:3000/api/register-parent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok && result.success) {
                displayMessage('Account created! Sending welcome email to student...', 'success');

                // Send email via EmailJS
                try {
                    await emailjs.send(
                        "service_poxi2u9",
                        "template_owpjk3s",
                        {
                            to_email: data.studentEmail,                // ✅ student email (already correct)
                            student_name: data.studentName,
                            parent_name: data.parentName,
                            student_temp_password: result.studentTempPassword // ✅ NEW
                        }
                    );

                    console.log("Email sent successfully");
                } catch (emailErr) {
                    console.error("EmailJS error:", emailErr);
                    displayMessage('Account created successfully, but failed to send email to student.', 'warning');
                }

                // Redirect after short delay
                setTimeout(() => {
                    window.location.href =
                        `parentdashboard.html?id=${result.parentId}&role=${encodeURIComponent(result.role)}&name=${encodeURIComponent(data.parentName)}`;
                }, 1500);

            } else {
                displayMessage(result.message || 'Error: Failed to create account.', 'danger');
            }
        } catch (error) {
            console.error('Network or Server Error:', error);
            displayMessage('Network error. Please ensure the server is running on port 3000.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Create Parent & Student Account';
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>